<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0f">
<title>PIK â€” Player Portal</title>
<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/@simplewebauthn/browser@11/dist/bundle/index.umd.min.js"></script>
<style>
/* â”€â”€ Reset & Root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root {
  --bg:       #0a0a0f;
  --bg2:      #12121a;
  --bg3:      #1a1a26;
  --surface:  #1e1e2e;
  --border:   #2a2a3a;
  --text:     #e0dde6;
  --text2:    #8a8698;
  --text3:    #5a5670;
  --accent:   #7c6aff;
  --accent2:  #ff6a8a;
  --gold:     #f0c050;
  --teal:     #40e8c0;
  --ember:    #ff8844;
  --radius:   12px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}
@font-face {
  font-family: 'Cinzel';
  src: url('https://fonts.gstatic.com/s/cinzel/v23/8vIU7ww63mVu7gtR-kwKxNvkNOjw-tbnfY3lCA.woff2') format('woff2');
  font-weight: 700;
  font-display: swap;
}
@font-face {
  font-family: 'Alegreya Sans';
  src: url('https://fonts.gstatic.com/s/alegreyasans/v24/5aUz9_-1phKLFgshYDvh6CjsCPdA3eke1.woff2') format('woff2');
  font-weight: 400;
  font-display: swap;
}
@font-face {
  font-family: 'Alegreya Sans';
  src: url('https://fonts.gstatic.com/s/alegreyasans/v24/5aUo9_-1phKLFgshYDvh6CjsCPdMt11Gpe1H.woff2') format('woff2');
  font-weight: 500;
  font-display: swap;
}
html { background: var(--bg); }
body {
  font-family: 'Alegreya Sans', Georgia, serif;
  color: var(--text);
  background: var(--bg);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bot);
}

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes glow {
  0%, 100% { box-shadow: 0 0 20px #7c6aff33; }
  50%      { box-shadow: 0 0 40px #7c6aff55; }
}
@keyframes shimmer {
  0%   { background-position: -200% center; }
  100% { background-position: 200% center; }
}
@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50%      { opacity: 1; }
}
@keyframes orbFloat {
  0%, 100% { transform: translateY(0) scale(1); }
  50%      { transform: translateY(-8px) scale(1.05); }
}
.fade-up {
  animation: fadeUp 0.5s ease-out both;
}
.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }
.delay-5 { animation-delay: 0.5s; }

/* â”€â”€ Background Texture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 0%, #7c6aff08 0%, transparent 50%),
    radial-gradient(ellipse at 80% 100%, #ff6a8a06 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100dvh;
  padding: 32px 24px;
  text-align: center;
  position: relative;
  z-index: 1;
}
.login-logo {
  width: 80px; height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Cinzel', serif;
  font-size: 28px;
  color: white;
  margin-bottom: 24px;
  animation: glow 3s ease-in-out infinite;
}
.login-title {
  font-family: 'Cinzel', serif;
  font-size: 28px;
  letter-spacing: 3px;
  color: var(--text);
  margin-bottom: 8px;
}
.login-subtitle {
  color: var(--text2);
  font-size: 15px;
  margin-bottom: 48px;
  letter-spacing: 0.5px;
}
.login-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 40px;
  background: linear-gradient(135deg, var(--accent), #6a56ee);
  color: white;
  border: none;
  border-radius: 50px;
  font-family: 'Alegreya Sans', serif;
  font-size: 17px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  letter-spacing: 0.5px;
}
.login-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px #7c6aff44;
}
.login-btn:active { transform: scale(0.97); }
.login-btn svg { width: 22px; height: 22px; }
.login-error {
  margin-top: 16px;
  color: var(--accent2);
  font-size: 13px;
  min-height: 20px;
}
.login-footer {
  position: absolute;
  bottom: 32px;
  color: var(--text3);
  font-size: 11px;
  letter-spacing: 1px;
}

/* â”€â”€ Portal (post-login) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#portal { display: none; position: relative; z-index: 1; }
#portal.active { display: block; }
#login-screen.hidden { display: none; }

/* â”€â”€ Header Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.portal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  position: sticky;
  top: 0;
  z-index: 10;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.portal-header-left {
  display: flex; align-items: center; gap: 10px;
}
.portal-header-mark {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-family: 'Cinzel', serif;
  font-size: 12px; color: white;
}
.portal-header-title {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  letter-spacing: 2px;
  color: var(--text2);
}
.btn-signout {
  background: none; border: 1px solid var(--border);
  color: var(--text2); font-size: 12px;
  padding: 6px 14px; border-radius: 20px;
  font-family: inherit; cursor: pointer;
  transition: all 0.2s;
}
.btn-signout:hover { border-color: var(--accent2); color: var(--accent2); }

/* â”€â”€ Hero Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hero-section {
  padding: 32px 20px 24px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.hero-section::before {
  content: '';
  position: absolute;
  top: -60px; left: 50%;
  transform: translateX(-50%);
  width: 300px; height: 300px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
  opacity: 0.06;
  pointer-events: none;
}
.hero-orb {
  width: 96px; height: 96px;
  margin: 0 auto 20px;
  border-radius: 50%;
  position: relative;
  animation: orbFloat 4s ease-in-out infinite;
}
.hero-orb-ring {
  position: absolute; inset: 0;
  border-radius: 50%;
  border: 3px solid transparent;
  border-top-color: var(--accent);
  border-right-color: var(--accent);
  animation: spin 3s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.hero-orb-inner {
  position: absolute;
  inset: 8px;
  border-radius: 50%;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.hero-orb-level {
  font-family: 'Cinzel', serif;
  font-size: 28px;
  color: var(--gold);
  line-height: 1;
}
.hero-orb-label {
  font-size: 9px;
  color: var(--text3);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-top: 2px;
}
.hero-name {
  font-family: 'Cinzel', serif;
  font-size: 24px;
  letter-spacing: 1px;
  margin-bottom: 4px;
}
.hero-origin {
  color: var(--text2);
  font-size: 14px;
  margin-bottom: 4px;
}
.hero-alignment {
  display: inline-block;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 3px 14px;
  border-radius: 20px;
  border: 1px solid;
}
.hero-alignment.Order  { color: var(--teal); border-color: var(--teal); }
.hero-alignment.Chaos  { color: var(--accent2); border-color: var(--accent2); }
.hero-alignment.Wild   { color: var(--ember); border-color: var(--ember); }

/* â”€â”€ XP Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.xp-section {
  padding: 0 20px 28px;
}
.xp-bar-wrap {
  background: var(--bg3);
  border-radius: 8px;
  padding: 14px 16px;
  border: 1px solid var(--border);
}
.xp-bar-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 10px;
}
.xp-bar-label {
  font-size: 11px;
  color: var(--text3);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}
.xp-bar-numbers {
  font-size: 13px;
  color: var(--text2);
}
.xp-bar-numbers strong {
  color: var(--gold);
  font-weight: 500;
}
.xp-bar-track {
  height: 6px;
  background: var(--bg);
  border-radius: 3px;
  overflow: hidden;
}
.xp-bar-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  transition: width 1s ease-out;
  position: relative;
}
.xp-bar-fill::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s ease-in-out infinite;
}
.xp-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
.xp-stat {
  font-size: 12px;
  color: var(--text3);
}
.xp-stat strong {
  color: var(--text);
  font-weight: 500;
}

/* â”€â”€ Section Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section {
  padding: 0 16px 20px;
}
.section-card {
  background: var(--bg2);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
}
.section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 16px 10px;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
}
.section-header svg { width: 14px; height: 14px; opacity: 0.5; }

/* â”€â”€ Titles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.titles-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 0 16px 16px;
}
.title-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--bg3);
  border-radius: 20px;
  font-size: 12px;
  color: var(--gold);
  border: 1px solid #f0c05020;
  letter-spacing: 0.3px;
}
.title-badge .icon { font-size: 13px; }
.empty-state {
  padding: 20px 16px;
  text-align: center;
  color: var(--text3);
  font-size: 13px;
  font-style: italic;
}

/* â”€â”€ Fate Markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.markers-list {
  padding: 0 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.marker-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--bg3);
  border-radius: 8px;
  font-size: 13px;
}
.marker-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--accent);
  flex-shrink: 0;
}

/* â”€â”€ Source Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sources-list {
  padding: 0 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.source-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  background: var(--bg3);
  border-radius: 10px;
  border: 1px solid var(--border);
}
.source-info { flex: 1; min-width: 0; }
.source-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.source-scope {
  font-size: 11px;
  color: var(--text3);
  margin-top: 2px;
}
.source-status {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 3px 10px;
  border-radius: 12px;
  flex-shrink: 0;
}
.source-status.active {
  color: var(--teal);
  background: #40e8c010;
  border: 1px solid #40e8c030;
}
.source-status.revoked {
  color: var(--accent2);
  background: #ff6a8a10;
  border: 1px solid #ff6a8a30;
}

/* â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-list {
  padding: 0 16px 16px;
}
.tl-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.tl-item:last-child { border-bottom: none; }
.tl-dot-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 4px;
  flex-shrink: 0;
  width: 20px;
}
.tl-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.tl-dot.session   { background: var(--accent); }
.tl-dot.marker    { background: var(--ember); }
.tl-dot.enrolled  { background: var(--teal); }
.tl-dot.link      { background: var(--gold); }
.tl-dot.auth      { background: var(--text3); }
.tl-dot.key       { background: var(--accent2); }
.tl-line {
  width: 1px;
  flex: 1;
  background: var(--border);
  margin-top: 4px;
}
.tl-content { flex: 1; min-width: 0; }
.tl-title {
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 2px;
}
.tl-detail {
  font-size: 12px;
  color: var(--text2);
}
.tl-detail .xp-gain {
  color: var(--gold);
  font-weight: 500;
}
.tl-detail .level-up {
  color: var(--teal);
  font-weight: 500;
}
.tl-detail .title-earn {
  color: var(--accent);
}
.tl-time {
  font-size: 11px;
  color: var(--text3);
  margin-top: 3px;
}
.tl-source {
  display: inline-block;
  font-size: 10px;
  color: var(--text3);
  background: var(--bg3);
  padding: 1px 8px;
  border-radius: 8px;
  margin-top: 4px;
}

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.portal-footer {
  text-align: center;
  padding: 32px 20px 48px;
  color: var(--text3);
  font-size: 11px;
  letter-spacing: 1px;
}
.portal-footer a {
  color: var(--accent);
  text-decoration: none;
}

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60dvh;
  gap: 16px;
}
.loading-spinner {
  width: 40px; height: 40px;
  border-radius: 50%;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  animation: spin 0.8s linear infinite;
}
.loading-text {
  color: var(--text3);
  font-size: 13px;
  animation: pulse 1.5s ease-in-out infinite;
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  LOGIN SCREEN                                          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-logo fade-up">P</div>
  <div class="login-title fade-up delay-1">PLAYER PORTAL</div>
  <div class="login-subtitle fade-up delay-2">Your identity. Every world.</div>

  <button class="login-btn fade-up delay-3" onclick="doSignIn()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
    </svg>
    Sign in with Passkey
  </button>

  <div id="login-error" class="login-error fade-up delay-4"></div>
  <div class="login-footer fade-up delay-5">PIK â€” PERSISTENT IDENTITY KERNEL</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PORTAL (shown after auth)                             -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="portal">
  <!-- Header -->
  <div class="portal-header">
    <div class="portal-header-left">
      <div class="portal-header-mark">P</div>
      <span class="portal-header-title">PIK</span>
    </div>
    <button class="btn-signout" onclick="doSignOut()">Sign Out</button>
  </div>

  <!-- Content container -->
  <div id="portal-content">
    <div class="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading your identity...</div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.location.origin + '/api';
let session = null; // { token, rootId, heroName }

// â”€â”€ API Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (session?.token) headers['Authorization'] = `Bearer ${session.token}`;
  const resp = await fetch(API + path, { ...opts, headers });
  if (!resp.ok) {
    const body = await resp.json().catch(() => ({}));
    throw new Error(body.message || `HTTP ${resp.status}`);
  }
  return resp.json();
}

// â”€â”€ Sign In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSignIn() {
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';

  try {
    // 1. Get authentication options (discoverable)
    const optResp = await apiFetch('/auth/authenticate/options', {
      method: 'POST',
      body: JSON.stringify({}),
    });
    // Unwrap â€” response interceptor nests in {status, data}
    let options = optResp.data || optResp;
    // Handle if auth service double-wraps
    if (options.data) options = options.data;
    console.log('Auth options:', JSON.stringify(options).substring(0, 200));

    // 2. Browser WebAuthn ceremony
    const assertion = await SimpleWebAuthnBrowser.startAuthentication({ optionsJSON: options });

    // 3. Verify with server
    const verifyResp = await apiFetch('/auth/authenticate/verify', {
      method: 'POST',
      body: JSON.stringify({ assertion }),
    });

    const d = verifyResp.data;
    session = {
      token: d.token || d.session_token,
      rootId: d.root_id,
      heroName: d.hero_name,
    };

    // Switch to portal
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('portal').classList.add('active');

    await loadProfile();
  } catch (err) {
    console.error('Sign-in error:', err);
    if (err.name === 'NotAllowedError') {
      errEl.textContent = 'Authentication was cancelled.';
    } else {
      errEl.textContent = err.message || 'Sign-in failed. Try again.';
    }
  }
}

// â”€â”€ Sign Out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSignOut() {
  session = null;
  document.getElementById('portal').classList.remove('active');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('portal-content').innerHTML =
    '<div class="loading-screen"><div class="loading-spinner"></div><div class="loading-text">Loading your identity...</div></div>';
}

// â”€â”€ Load Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile() {
  try {
    const resp = await apiFetch(`/users/${session.rootId}`);
    const d = resp.data;
    renderProfile(d);
  } catch (err) {
    console.error('Load error:', err);
    document.getElementById('portal-content').innerHTML =
      `<div class="loading-screen"><div class="loading-text" style="color:var(--accent2)">${err.message}</div></div>`;
  }
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProfile(d) {
  const p = d.persona;
  const prog = d.progression;
  const links = d.source_links || [];
  const events = d.recent_events || [];

  const xpPct = prog.xp_needed_for_next > 0
    ? Math.min(100, Math.round((prog.xp_in_current_level / prog.xp_needed_for_next) * 100))
    : 100;

  const container = document.getElementById('portal-content');
  container.innerHTML = `
    <!-- Hero -->
    <div class="hero-section fade-up">
      <div class="hero-orb">
        <div class="hero-orb-ring"></div>
        <div class="hero-orb-inner">
          <div class="hero-orb-level">${prog.fate_level}</div>
          <div class="hero-orb-label">LEVEL</div>
        </div>
      </div>
      <div class="hero-name">${esc(p.hero_name)}</div>
      <div class="hero-origin">${esc(p.origin || 'Unknown Origin')}</div>
      <span class="hero-alignment ${p.fate_alignment}">${p.fate_alignment}</span>
    </div>

    <!-- XP -->
    <div class="xp-section fade-up delay-1">
      <div class="xp-bar-wrap">
        <div class="xp-bar-header">
          <span class="xp-bar-label">Fate Progress</span>
          <span class="xp-bar-numbers"><strong>${prog.fate_xp.toLocaleString()}</strong> Total XP</span>
        </div>
        <div class="xp-bar-track">
          <div class="xp-bar-fill" style="width: ${xpPct}%"></div>
        </div>
        <div class="xp-stats">
          <span class="xp-stat"><strong>${prog.xp_in_current_level}</strong> / ${prog.xp_needed_for_next} to next level</span>
          <span class="xp-stat"><strong>${prog.total_sessions}</strong> sessions</span>
        </div>
      </div>
    </div>

    <!-- Titles -->
    <div class="section fade-up delay-2">
      <div class="section-card">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          TITLES EARNED
        </div>
        ${prog.titles.length
          ? `<div class="titles-grid">${prog.titles.map(t => `<span class="title-badge"><span class="icon">âœ¦</span>${formatTitle(t)}</span>`).join('')}</div>`
          : '<div class="empty-state">No titles earned yet â€” complete sessions to unlock.</div>'
        }
      </div>
    </div>

    <!-- Fate Markers -->
    <div class="section fade-up delay-3">
      <div class="section-card">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          FATE MARKERS
        </div>
        ${prog.fate_markers.length
          ? `<div class="markers-list">${prog.fate_markers.map(m => `<div class="marker-row"><div class="marker-dot"></div>${esc(formatMarker(m))}</div>`).join('')}</div>`
          : '<div class="empty-state">No fate markers yet â€” explore deeper to unlock.</div>'
        }
      </div>
    </div>

    <!-- Connected Sources -->
    <div class="section fade-up delay-4">
      <div class="section-card">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
          CONNECTED WORLDS
        </div>
        ${links.length
          ? `<div class="sources-list">${links.map(l => `
              <div class="source-card">
                <div class="source-info">
                  <div class="source-name">${esc(l.source_name)}</div>
                  <div class="source-scope">${esc(l.scope)}</div>
                </div>
                <span class="source-status ${l.status}">${l.status}</span>
              </div>
            `).join('')}</div>`
          : '<div class="empty-state">No worlds connected yet.</div>'
        }
      </div>
    </div>

    <!-- Timeline -->
    <div class="section fade-up delay-5">
      <div class="section-card">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          JOURNEY
        </div>
        <div class="timeline-list">
          ${events.map(ev => renderTimelineItem(ev)).join('')}
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="portal-footer">
      PIK â€” PERSISTENT IDENTITY KERNEL<br>
      <span style="opacity:0.5">Your identity. Every world.</span>
    </div>
  `;
}

// â”€â”€ Timeline Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTimelineItem(ev) {
  const type = ev.event_type;
  const ch = ev.changes || ev.changes_applied || {};
  const pl = ev.payload || {};
  let dot = 'auth';
  let title = type;
  let detail = '';

  if (type === 'progression.session_completed') {
    dot = 'session';
    title = 'Session Completed';
    const parts = [];
    if (ch.total_xp) parts.push(`<span class="xp-gain">+${ch.total_xp} XP</span>`);
    if (ch.level_up) parts.push(`<span class="level-up">Level ${ch.level_up.from} â†’ ${ch.level_up.to}</span>`);
    if (ch.title_granted) parts.push(`<span class="title-earn">ğŸ† ${formatTitle(ch.title_granted)}</span>`);
    if (pl.difficulty) parts.push(`${pl.difficulty} difficulty`);
    detail = parts.join(' Â· ');
  } else if (type === 'progression.fate_marker') {
    dot = 'marker';
    title = 'Fate Marker Unlocked';
    detail = formatMarker(pl.marker || ch.marker || '');
  } else if (type === 'identity.enrolled') {
    dot = 'enrolled';
    title = 'Identity Created';
    detail = `${esc(pl.hero_name || '')} enrolled`;
  } else if (type === 'source.link_granted') {
    dot = 'link';
    title = 'World Connected';
    detail = ev.source_name || pl.source_id || '';
  } else if (type === 'identity.authenticated') {
    dot = 'auth';
    title = 'Signed In';
    detail = pl.device_type || '';
  } else if (type === 'key.registered') {
    dot = 'key';
    title = 'Passkey Registered';
    detail = pl.friendly_name || '';
  }

  return `
    <div class="tl-item">
      <div class="tl-dot-col">
        <div class="tl-dot ${dot}"></div>
        <div class="tl-line"></div>
      </div>
      <div class="tl-content">
        <div class="tl-title">${title}</div>
        ${detail ? `<div class="tl-detail">${detail}</div>` : ''}
        <div class="tl-time">${fmtTime(ev.created_at)}</div>
        ${ev.source_name ? `<span class="tl-source">${esc(ev.source_name)}</span>` : ''}
      </div>
    </div>
  `;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function formatTitle(t) {
  if (!t) return '';
  return t
    .replace(/^title_/, '')
    .replace(/_/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

function formatMarker(m) {
  if (!m) return '';
  return m
    .replace(/^node:/, '')
    .replace(/[-_]/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

function fmtTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const now = new Date();
  const diffMs = now - d;
  const diffMin = Math.floor(diffMs / 60000);
  const diffHr = Math.floor(diffMs / 3600000);
  const diffDay = Math.floor(diffMs / 86400000);

  if (diffMin < 1) return 'Just now';
  if (diffMin < 60) return `${diffMin}m ago`;
  if (diffHr < 24) return `${diffHr}h ago`;
  if (diffDay < 7) return `${diffDay}d ago`;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// â”€â”€ Deep Link: auto-sign-in if hash has root_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Future: QR codes can link to /portal#auto which triggers sign-in
if (window.location.hash === '#auto') {
  window.addEventListener('load', () => {
    setTimeout(doSignIn, 500);
  });
}
</script>
</body>
</html>
